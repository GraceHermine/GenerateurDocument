<section class="public-container">
  <!-- DEBUG: Afficher les questions reçues
  <div style="background: #ffe; padding: 10px; margin: 10px; font-size: 12px; border: 1px solid #cc0;">
    <strong>DEBUG:</strong> {{ questions.length }} questions chargées<br>
    <span *ngFor="let q of questions">
      [ID:{{q.id}} type:{{q.type_champ}}] 
    </span>
  </div> -->

  <div *ngIf="!isStepPreview" class="public-panel public-reveal">
    <span class="public-kicker">Formulaire</span>
    <h1 class="public-title">{{ template?.nom }}</h1>
    <p class="public-subtitle">{{ progress }}% rempli</p>
  </div>

  <div *ngIf="!isStepPreview" class="public-section">
    <div class="public-grid">
      <div *ngFor="let q of questions" class="public-card public-reveal">
        <label class="public-badge">
          {{ q.label }} <span *ngIf="q.obligatoire">*</span>
        </label>

        <textarea
          *ngIf="q.type_champ === 'text'"
          [(ngModel)]="responses[q.id]"
          (ngModelChange)="onResponseChange()"
          class="public-textarea"
          rows="3"></textarea>

        <select
          *ngIf="q.type_champ === 'select'"
          [(ngModel)]="responses[q.id]"
          (ngModelChange)="onResponseChange()"
          class="public-input">
          <option *ngFor="let opt of q.options" [value]="opt">{{ opt }}</option>
        </select>

        <input
          *ngIf="q.type_champ === 'date'"
          type="date"
          [(ngModel)]="responses[q.id]"
          (ngModelChange)="onResponseChange()"
          class="public-input" />

          <input
          *ngIf="q.type_champ === 'email'"
          type="email"
          [(ngModel)]="responses[q.id]"
          (ngModelChange)="onResponseChange()"
          class="public-input"
          placeholder="exemple@domaine.com" />

        <input
          *ngIf="q.type_champ === 'number'"
          type="number"
          [(ngModel)]="responses[q.id]"
          (ngModelChange)="onResponseChange()"
          class="public-input" />
      </div>
    </div>

    <div style="margin-top: 18px; display: flex; justify-content: flex-end;">
      <button (click)="goToPreview()" [disabled]="!isFormValid()" class="public-btn public-btn--primary">
        Generer l'apercu
      </button>
    </div>
  </div>

  <div *ngIf="isStepPreview" class="public-section">
    <div class="public-panel public-reveal">
      <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px;">
        <h2>Apercu du document</h2>
        <button (click)="isStepPreview = false" class="public-btn public-btn--ghost">Modifier</button>
      </div>

      <div class="public-panel" style="margin-top: 16px;">
        <div [ngSwitch]="getTemplateType()">
          <div *ngSwitchCase="'lettre'">
            <p><strong>{{ getVal('Nom') }} {{ getVal('Prénom') }}</strong></p>
            <p>{{ getVal('Adresse') }}</p>
            <p>{{ getVal('Téléphone') }}</p>
            <p style="margin-top: 16px;">Le {{ today | date:'dd MMMM yyyy' }}</p>
            <p style="margin-top: 16px;">{{ getVal('Contenu') || getVal('Motivation') || '[Contenu du document]' }}</p>
          </div>

          <div *ngSwitchCase="'cv'">
            <p><strong>{{ getVal('Nom') }} {{ getVal('Prénom') }}</strong></p>
            <p>{{ getVal('Poste') || 'CANDIDAT' }}</p>
            <p>{{ getVal('Email') }}</p>
          </div>

          <div *ngSwitchDefault>
            <h3>{{ template?.nom }}</h3>
            <div *ngFor="let q of questions" style="margin-top: 8px;">
              <p class="public-badge">{{ q.label }}</p>
              <p>{{ responses[q.id] || '......' }}</p>
            </div>
          </div>
        </div>
      </div>

      <div class="public-actions" style="margin-top: 16px;">
        <button (click)="openDownloadOptions()" [disabled]="isGenerating" class="public-btn public-btn--primary">
          <span *ngIf="!isGenerating">Telecharger le document</span>
          <span *ngIf="isGenerating">Generation en cours...</span>
        </button>
        <button (click)="cancelForm()" class="public-btn public-btn--ghost">Abandonner</button>
      </div>
    </div>
  </div>

  <div *ngIf="showFormatModal" class="public-panel" style="max-width: 420px; margin: 24px auto;">
    <h3>Choisir le format</h3>
    <p class="public-card-text">Sous quel format souhaitez-vous recevoir votre document ?</p>
    <div class="public-actions">
      <button (click)="generateDocument('pdf')" class="public-btn public-btn--ghost">Format PDF</button>
      <button (click)="generateDocument('docx')" class="public-btn public-btn--ghost">Format Word</button>
      <button (click)="showFormatModal = false" class="public-btn public-btn--ghost">Annuler</button>
    </div>
  </div>
</section>