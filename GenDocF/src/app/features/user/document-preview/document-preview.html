<div class="page" *ngIf="document; else loading">
  <header class="topbar">
    <a routerLink="/user/document" class="back-link">
      <span class="material-symbols-outlined">arrow_back</span>
      Retour aux documents
    </a>
    <div class="title-block">
      <h1 class="title">{{ document.titre }}</h1>
      <div class="meta">
        <span class="status" [attr.data-status]="document.statut">
          {{ document.statut | uppercase }}
        </span>
        <span class="dot">â€¢</span>
        <span>Modifie le {{ document.updated_at | date:'dd/MM/yyyy HH:mm' }}</span>
      </div>
    </div>
    <div class="actions">
      <button class="btn secondary" (click)="downloadDocument()">
        <span class="material-symbols-outlined">download</span>
        Telecharger
      </button>
      <button class="btn ghost" *ngIf="document.statut !== 'archive'" (click)="archiverDocument()">
        <span class="material-symbols-outlined">archive</span>
        Archiver
      </button>
      <button class="btn danger" (click)="deleteDocument()">
        <span class="material-symbols-outlined">delete</span>
        Supprimer
      </button>
    </div>
  </header>

  <a routerLink="/user/document" class="back-float" aria-label="Retour aux documents">
    <span class="material-symbols-outlined">arrow_back</span>
  </a>

  <div class="content">
    <section class="preview-card">
      <div class="preview-header">
        <div>
          <p class="label">Template</p>
          <p class="value">{{ document.template_details?.nom || 'Template' }}</p>
        </div>
        <div>
          <p class="label">Statut</p>
          <p class="value">{{ document.statut }}</p>
        </div>
      </div>
      <div class="preview-body">
        <div class="paper" *ngIf="!pdfUrl">
          <h2>{{ document.titre }}</h2>
          <div class="html" [innerHTML]="document.contenu_final"></div>
        </div>
        <div class="pdf" *ngIf="pdfUrl">
          <iframe [src]="pdfUrl" title="Apercu PDF" loading="lazy"></iframe>
        </div>
        <div class="pdf-state" *ngIf="isPdfLoading">
          <div class="spinner"></div>
          <p>Chargement du PDF...</p>
        </div>
        <div class="pdf-state" *ngIf="pdfError">
          <p>{{ pdfError }}</p>
          <button class="btn secondary" (click)="loadPdfPreview()">Reessayer</button>
        </div>
      </div>
    </section>

    <aside class="side">
      <div class="panel">
        <h2>Informations</h2>
        <dl>
          <div>
            <dt>ID</dt>
            <dd>{{ document.id }}</dd>
          </div>
          <div>
            <dt>Cree le</dt>
            <dd>{{ document.created_at | date:'dd/MM/yyyy' }}</dd>
          </div>
          <div>
            <dt>Modifie le</dt>
            <dd>{{ document.updated_at | date:'dd/MM/yyyy HH:mm' }}</dd>
          </div>
          <div>
            <dt>Template</dt>
            <dd>{{ document.template }}</dd>
          </div>
        </dl>
      </div>

      <div class="panel" *ngIf="document.reponses && document.reponses.length > 0">
        <h2>Reponses</h2>
        <div class="answers">
          <div class="answer" *ngFor="let reponse of document.reponses">
            <p class="q">{{ reponse.question_details?.label }}</p>
            <p class="a">{{ reponse.reponse }}</p>
          </div>
        </div>
      </div>
    </aside>
  </div>
</div>

<ng-template #loading>
  <div class="loading">
    <div class="spinner"></div>
    <p>Chargement du document...</p>
  </div>
</ng-template>